box:
  id: alpine:3.5
  cmd: /bin/sh

ignore-file: .werckerignore

build:
  steps:
    - script:
        name: Build
        code: >
          apk --update --no-cache add python curl && \
          mkdir /opt && cd /opt && \
          curl https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-175.0.0-linux-x86_64.tar.gz | tar xz && \
          cd /opt/google-cloud-sdk/ && ./install.sh --quiet \
            --usage-reporting false \
            --additional-components \
                docker-credential-gcr \
                kubectl \
                beta && \

          rm -rf /tmp/*

deploy:
  steps:
    - script:
        name: Setup the container
        code: >
          apk --update --no-cache add python curl && \

          mkdir /opt && cd /opt && \
          curl https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-175.0.0-linux-x86_64.tar.gz | tar xz && \

          cd /opt/google-cloud-sdk/ && ./install.sh --quiet \
            --usage-reporting false \
            --additional-components \
                docker-credential-gcr \
                kubectl \
                beta && \

          rm -rf /tmp/*

    - internal/docker-push:
        username: $DOCKER_USERNAME
        password: $DOCKER_PASSWORD
        tag: latest,$WERCKER_GIT_COMMIT,175.0.0
        repository: abuecker/gcloud-sdk
        registry: https://registry.hub.docker.com
        env: PATH=/opt/google-cloud-sdk/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

